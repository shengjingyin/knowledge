# 单例模式

Vuex 实现了一个全局的 Store 用于存储应用的所有状态, 这个 Store 的实现，正是单例模式的典型应用

如果我在 install 里没有实现单例模式，会带来什么样的麻烦？

我们通过上面的源码解析可以看出，每次 install 都会为 Vue 实例初始化一个 Store。假如 install 里没有单例模式的逻辑，那我们如果在一个应用里不小心多次安装了插件：

```js
// 在主文件里安装Vuex
Vue.use(Vuex)

...(中间添加/修改了一些store的数据)

// 在后续的逻辑里不小心又安装了一次
Vue.use(Vuex)
```

失去了单例判断能力的 install 方法，会为当前的 Vue 实例重新注入一个新的 Store，也就是说你中间的那些数据操作全都没了，一切归 0。因此，单例模式在此处是非常必要的。

## 实现单例模式

### class 静态方法实现

```js
class Single {
    static getInstance() {
        if (!Single.instance) {
            Single.instance = new Single();
        }
        return Single.instance;
    }
}

const s1 = Single.getInstance();
const s2 = Single.getInstance();
console.log("s1 === s2", s1 === s2);	// true
```

### 闭包实现

```js
class Single {}

Single.getInstance = (() => {
    let instance = null;
    return function () {
        if (!instance) {
            instance = new Single();
        }
        return instance;
    };
})();

const s1 = Single.getInstance();
const s2 = Single.getInstance();
console.log("s1 === s2", s1 === s2);	// true
```

## 面试题

### 实现 Storage，使得该对象为单例

> 静态方法版本

```js
/* 单例 Storage */
class Storage {
    static getInstance() {
        if (!Storage.instance) {
            Storage.instance = new Storage();
        }
        return Storage.instance;
    }
    setItem(key, val) {
        return localStorage.setItem(key, val);
    }
    getItem(key) {
        return localStorage.getItem(key);
    }
}

const storage1 = Storage.getInstance();
const storage2 = Storage.getInstance();

storage1.setItem("name", "李磊");
storage2.setItem("name", "小明");

console.log("dd",  storage1 === storage2); 	// true
```

> 闭包版本

```js
// 先实现一个基础的StorageBase类，把getItem和setItem方法放在它的原型链上
function StorageBase () {}
StorageBase.prototype.getItem = function (key){
    return localStorage.getItem(key)
}
StorageBase.prototype.setItem = function (key, value) {
    return localStorage.setItem(key, value)
}

// 以闭包的形式创建一个引用自由变量的构造函数
const Storage = (function(){
    let instance = null
    return function(){
        // 判断自由变量是否为null
        if(!instance) {
            // 如果为null则new出唯一实例
            instance = new StorageBase()
        }
        return instance
    }
})()

// 这里其实不用 new Storage 的形式调用，直接 Storage() 也会有一样的效果 
const storage1 = new Storage()
const storage2 = new Storage()

storage1.setItem('name', '李雷')
// 李雷
storage1.getItem('name')
// 也是李雷
storage2.getItem('name')

// 返回true
storage1 === storage2
```

### 实现一个全局的模态框

```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>单例模式弹框</title>
    </head>
    <style>
        #modal {
            height: 200px;
            width: 200px;
            line-height: 200px;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid black;
            text-align: center;
        }
    </style>
    <body>
        <button id="open">打开弹框</button>
        <button id="close">关闭弹框</button>
    </body>
    <script>
        // 核心逻辑，这里采用了闭包思路来实现单例模式
        /*      const Model = (function () {
            let modal = null;
            return function () {
                if (!modal) {
                    modal = document.createElement("div");
                    modal.innerHTML = "我是一个全局唯一的Modal";
                    modal.id = "modal";
                    modal.style.display = "none";
                    document.body.appendChild(modal);
                }
                return modal;
            };
        })(); */
        // 静态方法实现
        class Model {
            static getInstance() {
                if (!Model.instance) {
                    Model.instance = document.createElement("div");
                    Model.instance.innerHTML = "我是一个全局唯一的Modal";
                    Model.instance.id = "modal";
                    Model.instance.style.display = "none";
                    document.body.appendChild(Model.instance);
                }
                return Model.instance;
            }
        }

        // 点击打开按钮展示模态框
        document.getElementById("open").addEventListener("click", function () {
            const model = Model.getInstance();
            modal.style.display = "block";
        });

        // 点击关闭按钮隐藏模态框
        document.getElementById("close").addEventListener("click", function () {
            const modal = Model.getInstance();
            if (modal) {
                modal.style.display = "none";
            }
        });
    </script>
</html>
```







